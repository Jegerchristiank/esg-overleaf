% Common packages and configuration for the KU thesis template
\usepackage{KUstyle}
\usepackage[margin=0.8in]{geometry}
\usepackage{iftex}
\usepackage{fontspec}
\usepackage[english,danish]{babel}
\usepackage{csquotes}
\usepackage{setspace}
\usepackage{tabularx}
\usepackage{amsmath}
\usepackage{siunitx}
\usepackage{mdframed}
\usepackage{booktabs} % Consistent table rules for evidence tables.

% Package decisions:
% - siunitx: used for numeric examples/units.
% - longtable: add only if a table must span multiple pages.

% Label conventions:
% sec:, subsec:, fig:, tab:, eq:, app:

% Main font configuration
\setmainfont{Arial}

% Numeric and unit formatting (Danish decimal comma).
\sisetup{
  output-decimal-marker = {,},
  group-separator = {.},
  group-minimum-digits = 4
}

% Table/figure source and note helpers (use below floats).
\newcommand{\TableSource}[1]{\par{\small\textit{Kilde: #1}}}
\newcommand{\TableNote}[1]{\par{\small\textit{Note: #1}}}
\newcommand{\FigureSource}[1]{\par{\small\textit{Kilde: #1}}}

% Table standard: caption above (label after caption), booktabs rules, source/note below tabular.
% Figure standard: PDF/PNG preferred, 300 dpi for raster, caption+label, source below.

% Bibliography setup
\usepackage[backend=biber,style=authoryear,maxcitenames=2,giveninits=true]{biblatex}
\addbibresource{references.bib}

% Customisation of default names
\renewcommand{\contentsname}{Indholdsfortegnelse}

% Legal reference helpers.
\newcommand{\lawpar}[1]{\S~#1}
\newcommand{\lawart}[1]{art.~#1}

% Quote styling: make display quotes visually distinct and attributable.
\newmdenv[
  leftline=true,
  rightline=false,
  topline=false,
  bottomline=false,
  linecolor=KUrod,
  linewidth=2pt,
  backgroundcolor=black!5,
  skipabove=\baselineskip,
  skipbelow=\baselineskip,
  innerleftmargin=0.8em,
  innerrightmargin=0.8em,
  innertopmargin=0.6em,
  innerbottommargin=0.6em
]{quoteblock}

\newcommand{\quoteattrib}[1]{\par\hfill--- \normalfont #1}

\renewenvironment{displayquote}{\begin{quoteblock}\small\itshape}{\end{quoteblock}}

% Normal page count (2400 characters incl. spaces) for the cover.
% LuaLaTeX writes normalpages-count.tex at end; recompile to refresh the cover.
\newcommand{\NormalPageCount}{?}
\newcommand{\NormalCharCount}{0}
\InputIfFileExists{normalpages-count.tex}{}{}

\ifluatex


  \newcommand{\NormalTextOff}{%
    \global\advance\KU@countlevel by 1\relax
    \KU@updatecountstate
  }

  \newcommand{\NormalTextOn}{%
    \global\advance\KU@countlevel by -1\relax
    \ifnum\KU@countlevel<0\relax
      \global\KU@countlevel=0\relax
    \fi
    \KU@updatecountstate
  }

  \AtBeginDocument{%
    \KU@updatecountstate
    \directlua{
      ku_charcount = 0
      ku_counting = false

      local node_id = node.id
      local glyph_id = node_id("glyph")
      local glue_id = node_id("glue")
      local hlist_id = node_id("hlist")
      local vlist_id = node_id("vlist")
      local ins_id = node_id("ins")
      local math_id = node_id("math")

      local glue_subtypes = node.subtypes("glue")
      local space_subtypes = {}
      if glue_subtypes then
        local spaceskip = glue_subtypes.spaceskip or glue_subtypes.space
        local xspaceskip = glue_subtypes.xspaceskip or glue_subtypes.xspace
        if spaceskip then
          space_subtypes[spaceskip] = true
        end
        if xspaceskip then
          space_subtypes[xspaceskip] = true
        end
      end

      local function count_list(head)
        for n in node.traverse(head) do
          local id = n.id
          if id == glyph_id then
            ku_charcount = ku_charcount + 1
          elseif id == glue_id then
            if space_subtypes[n.subtype] then
              ku_charcount = ku_charcount + 1
            end
          elseif id == hlist_id or id == vlist_id or id == ins_id or id == math_id then
            local list = n.list
            if list then
              count_list(list)
            end
          end
        end
      end

      local function count_paragraph(head)
        if ku_counting then
          count_list(head)
        end
        return head
      end

      callback.register("pre_linebreak_filter", count_paragraph)
    }
  }

  \AtEndDocument{%
    \directlua{
      local pages = ku_charcount / 2400
      local pages_str = string.format("%.1f", pages)
      pages_str = pages_str:gsub("%.", ",")
      local f = io.open("normalpages-count.tex", "w")
      if f then
        f:write("%% Auto-generated.\n")
        f:write("\\renewcommand{\\NormalPageCount}{", pages_str, "}\n")
        f:write("\\renewcommand{\\NormalCharCount}{", tostring(ku_charcount), "}\n")
        f:close()
      end
    }
  }
\else
  \newcommand{\NormalTextOff}{}
  \newcommand{\NormalTextOn}{}
\fi

\AddToHook{env/table/begin}{\NormalTextOff}
\AddToHook{env/table/end}{\NormalTextOn}
\AddToHook{env/table*/begin}{\NormalTextOff}
\AddToHook{env/table*/end}{\NormalTextOn}
\AddToHook{env/figure/begin}{\NormalTextOff}
\AddToHook{env/figure/end}{\NormalTextOn}
\AddToHook{env/figure*/begin}{\NormalTextOff}
\AddToHook{env/figure*/end}{\NormalTextOn}
\AddToHook{env/tabular/begin}{\NormalTextOff}
\AddToHook{env/tabular/end}{\NormalTextOn}
\AddToHook{env/tabular*/begin}{\NormalTextOff}
\AddToHook{env/tabular*/end}{\NormalTextOn}
\AddToHook{env/tabularx/begin}{\NormalTextOff}
\AddToHook{env/tabularx/end}{\NormalTextOn}
\AddToHook{env/longtable/begin}{\NormalTextOff}
\AddToHook{env/longtable/end}{\NormalTextOn}
\AddToHook{env/thebibliography/begin}{\NormalTextOff}
\AddToHook{cmd/printbibliography/before}{\NormalTextOff}
\AddToHook{cmd/appendix/after}{\NormalTextOff}
\AddToHook{cmd/caption/before}{\NormalTextOff}
\AddToHook{cmd/caption/after}{\NormalTextOn}
\AddToHook{cmd/captionof/before}{\NormalTextOff}
\AddToHook{cmd/captionof/after}{\NormalTextOn}
