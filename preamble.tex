% Common packages and configuration for the KU thesis template
\PassOptionsToPackage{table}{xcolor}
\usepackage{xcolor}
\usepackage{KUstyle}
\usepackage[margin=0.8in]{geometry}
\usepackage{fontspec}
\usepackage[english,danish]{babel}
\usepackage{setspace}
\usepackage{tabularx}
\usepackage{amsmath}
\usepackage{siunitx}
\usepackage{mdframed}
\usepackage{fvextra}
\usepackage{float}
\usepackage{booktabs} % Consistent table rules for evidence tables.
\usepackage{csquotes}

% Package decisions:
% - siunitx: used for numeric examples/units.
% - longtable: add only if a table must span multiple pages.

% Label conventions:
% sec:, subsec:, fig:, tab:, eq:, app:

% Main font configuration
\setmainfont{Arial}

% Reduce aggressive hyphenation to avoid hard word breaks in output.
\hyphenpenalty=800
\exhyphenpenalty=800
\emergencystretch=2em

% Numeric and unit formatting (Danish decimal comma).
\sisetup{
  output-decimal-marker = {,},
  group-separator = {.},
  group-minimum-digits = 4
}

% Table/figure source and note helpers (use below floats).
\newcommand{\TableSource}[1]{\par{\small\textit{Kilde: #1}}}
\newcommand{\TableNote}[1]{\par{\small\textit{Note: #1}}}
\newcommand{\FigureSource}[1]{\par{\small\textit{Kilde: #1}}}

% Table standard: caption above (label after caption), booktabs rules, source/note below tabular.
% Figure standard: PDF/PNG preferred, 300 dpi for raster, caption+label, source below.

% Bibliography setup
\usepackage[backend=biber,style=authoryear,maxcitenames=2,giveninits=true,uniquename=init]{biblatex}
\addbibresource{references.bib}

% Short-form parenthetical citations for selected institutional authors.
\DeclareCiteCommand{\parenciteshort}
  {\bibopenparen\usebibmacro{prenote}}
  {\ifnameundef{shortauthor}{\printnames{labelname}}{\printnames{shortauthor}}%
   \setunit{\nameyeardelim}%
   \printlabeldate}
  {\multicitedelim}
  {\usebibmacro{postnote}\bibcloseparen}

% Full-name narrative citations for institutional sources with shortauthor.
\DeclareCiteCommand{\textcitefull}
  {\usebibmacro{prenote}}
  {\printnames{author}\setunit{\nameyeardelim}\printtext[parens]{\printlabeldate}}
  {\multicitedelim}
  {\usebibmacro{postnote}}

% Customisation of default names
\renewcommand{\contentsname}{Indholdsfortegnelse}

% Approximate raw text count (chars incl. spaces) for chapters 02-10.
% Excludes tables/figures, citations, references, and front/back matter.
\newcommand{\RawCharCount}{0}
\newcommand{\RawPageCount}{0}
\newcommand{\RawCountSummary}{\RawCharCount\ tegn (ca.\ \RawPageCount\ sider)}
\AtBeginDocument{%
  \directlua{
    local files = {
      "opgaver/02.tex",
      "opgaver/03.tex",
      "opgaver/04.tex",
      "opgaver/05.tex",
      "opgaver/06.tex",
      "opgaver/07.tex",
      "opgaver/08.tex",
      "opgaver/09.tex",
      "opgaver/10.tex",
    }

    local function read_file(path)
      local f = io.open(path, "r")
      if not f then return "" end
      local content = f:read("*a")
      f:close()
      return content or ""
    end

    local function strip_comments(text)
      text = text:gsub("\\\\%%", "__PERCENT__")
      text = text:gsub("%%[^\n]*", "")
      text = text:gsub("__PERCENT__", "\\\\%%")
      return text
    end

    local function remove_env(text, env_pattern)
      local pattern = "\\\\begin%s*{" .. env_pattern .. "}%s*[%s%S]-\\\\end%s*{" .. env_pattern .. "}"
      return text:gsub(pattern, " ")
    end

    local function remove_cmd(text, cmd)
      for _ = 1, 3 do
        text = text:gsub("\\\\" .. cmd .. "%s*%b[]%s*%b{}", " ")
        text = text:gsub("\\\\" .. cmd .. "%s*%b{}", " ")
      end
      return text
    end

    local function clean(text)
      text = strip_comments(text)

      text = remove_env(text, "table")
      text = remove_env(text, "table%*")
      text = remove_env(text, "figure")
      text = remove_env(text, "figure%*")

      text = text:gsub("\\\\caption%s*%b[]%s*%b{}", " ")
      text = text:gsub("\\\\caption%s*%b{}", " ")

      text = text:gsub("[Tt]abel%s*\\\\ref%s*%b{}", " ")
      text = text:gsub("[Ff]igur%s*\\\\ref%s*%b{}", " ")
      text = text:gsub("[Ff]ig%.?%s*\\\\ref%s*%b{}", " ")
      text = text:gsub("[Bb]ilag%s*\\\\ref%s*%b{}", " ")

      local cite_cmds = {
        "parencite", "parenciteshort", "textcite", "textcitefull", "cite", "citep",
        "citet", "citeauthor", "citeyear", "footcite", "parencites", "autocite"
      }
      for _, cmd in ipairs(cite_cmds) do
        text = remove_cmd(text, cmd)
      end

      local ref_cmds = { "ref", "autoref", "cref", "Cref", "eqref", "pageref", "nameref" }
      for _, cmd in ipairs(ref_cmds) do
        text = remove_cmd(text, cmd)
      end

      local other_cmds = { "label", "addcontentsline", "addtocontents", "addtocounter" }
      for _, cmd in ipairs(other_cmds) do
        text = remove_cmd(text, cmd)
      end

      text = text:gsub("\\\\begin%s*%b{}", " ")
      text = text:gsub("\\\\end%s*%b{}", " ")
      text = text:gsub("\\\\item%s*%b[]", " ")
      text = text:gsub("\\\\item", " ")

      text = text:gsub("\\\\[A-Za-z@]+%*?", "")
      text = text:gsub("\\\\", " ")

      text = text:gsub("{", "")
      text = text:gsub("}", "")
      text = text:gsub("%$", "")

      text = text:gsub("%s+", " "):gsub("^%s+", ""):gsub("%s+$", "")
      return text
    end

    local all = ""
    for _, path in ipairs(files) do
      local content = read_file(path)
      if content and content ~= "" then
        all = all .. " " .. clean(content)
      end
    end

    all = all:gsub("%s+", " "):gsub("^%s+", ""):gsub("%s+$", "")
    local count = #all
    local pages = count / 2400

    tex.sprint("\\\\gdef\\\\RawCharCount{" .. count .. "}")
    tex.sprint(string.format("\\\\gdef\\\\RawPageCount{%.2f}", pages))
    texio.write_nl("log", "RAW_CHAR_COUNT: " .. count)
    texio.write_nl("log", string.format("RAW_PAGE_ESTIMATE: %.2f", pages))
  }
}


% Legal reference helpers.
\newcommand{\lawpar}[1]{\S~#1}
\newcommand{\lawart}[1]{art.~#1}

% Quote styling: make display quotes visually distinct and attributable.
\newmdenv[
  leftline=true,
  rightline=false,
  topline=false,
  bottomline=false,
  linecolor=KUrod,
  linewidth=2pt,
  backgroundcolor=black!5,
  skipabove=\baselineskip,
  skipbelow=\baselineskip,
  innerleftmargin=0.8em,
  innerrightmargin=0.8em,
  innertopmargin=0.6em,
  innerbottommargin=0.6em
]{quoteblock}

\newcommand{\quoteattrib}[1]{\par\hfill--- \normalfont #1}

\renewenvironment{displayquote}{\begin{quoteblock}\small\itshape}{\end{quoteblock}}
